#!/usr/bin/env bash
#
# Build apk by using gradle wrapper script inside current project.

set -eo pipefail

source ~/.dotfiles/scripts/lib/utils.sh
source ~/.dotfiles/scripts/lib/utils/find.sh

gradlew_path=$(find_file_hierarchical gradlew)

if [ -n "$ANDROID_STUDIO_JAVA_HOME" ]; then
  JAVA_HOME="$ANDROID_STUDIO_JAVA_HOME"
elif [ -n "$ANDROID_STUDIO_HOME" ]; then
  if is_mac; then
    JAVA_HOME="$ANDROID_STUDIO_HOME/Contents/jre/jdk/Contents/Home"
  else
    JAVA_HOME="$ANDROID_STUDIO_HOME/jre"
  fi
fi

if ! is_wsl; then
  export JAVA_HOME
  $gradlew_path "$@"
  exit
fi

# For WSL, we need to use `cmd.exe' to build, otherwise it may fail with android build tools not found.
# Note: the parenthesis here is very important. Once removed, the whitespace around `&' should also be removed, otherwise the JAVA_HOME will contain a trailing whitespace.
cmd.exe /c "(set JAVA_HOME=$(wslpath -w $JAVA_HOME)) & $(wslpath -w $gradlew_path)" "$@"
