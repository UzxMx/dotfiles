#!/usr/bin/env ruby

require 'thor'

# Refs:
#   https://mirrors.tuna.tsinghua.edu.cn/help/homebrew/
#   https://mirrors.tuna.tsinghua.edu.cn/help/homebrew-bottles/
class Main < Thor
  desc 'mirror_info', 'Show mirror info'
  def mirror_info
    puts "Repo: #{%x[git -C "$(brew --repo)" config --get remote.origin.url]}"
    puts "Core repo: #{%x[git -C "$(brew --repo homebrew/core)" config --get remote.origin.url]}"
    puts "Cask repo: #{%x[git -C "$(brew --repo homebrew/cask)" config --get remote.origin.url]}"
    puts "HOMEBREW_BOTTLE_DOMAIN=#{%x[echo $HOMEBREW_BOTTLE_DOMAIN]}"
  end

  desc 'use_mirror', 'Use mirror'
  option :formular, type: :boolean, default: true, desc: 'Use mirror for formular'
  option :bottle, type: :boolean, default: false, desc: 'Use mirror for bottle'
  option :reset, type: :boolean, default: false, desc: 'Reset mirror'
  def use_mirror
    ensure_brew

    if options[:formular]
      if options[:reset]
        remote_url = 'https://github.com/Homebrew/brew.git'
        core_remote_url = 'https://github.com/Homebrew/homebrew-core.git'
        cask_remote_url = 'https://github.com/Homebrew/homebrew-cask.git'
      else
        remote_url = 'https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git'
        core_remote_url = 'https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git'
        cask_remote_url = 'https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-cask.git'
      end

      system <<-EOF
        bash -c '
          repo="$(brew --repo)"
          if [ -z $repo ]; then
            exit 1
          fi
          git -C "$(brew --repo)" remote set-url origin #{remote_url}
          git -C "$(brew --repo homebrew/core)" remote set-url origin #{core_remote_url}
          git -C "$(brew --repo homebrew/cask)" remote set-url origin #{cask_remote_url}
        '
      EOF
    end

    if options[:bottle]
      if options[:reset]
        puts <<-EOF
Please execute below scripts to reset mirror for bottle:

unset HOMEBREW_BOTTLE_DOMAIN

        EOF
      else
        puts <<-EOF
Please execute below scripts to use mirror for bottle:

export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles

        EOF
      end
    end
  end

  private

  def fatal(msg)
    STDERR.puts "Error: #{msg}"
    exit 1
  end

  def ensure_brew
    `sh -c "type brew"`
    fatal 'Cannot find brew' unless $?.exitstatus.zero?
  end
end

Main.start(ARGV)
