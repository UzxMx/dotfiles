#!/usr/bin/env bash

set -e

dotfiles_dir="$(realpath "$(dirname "$BASH_SOURCE")/..")"

usage() {
  cat <<-EOF 1>&2
Select a command and run it. No argument is required.
EOF
  exit 1
}

run_with_arguments() {
  local input="$(rlwrap -S "Arguments: " -o cat)"
  local args
  eval args=($input)
  "$1" "${args[@]}"
}

switch_locale() {
  echo export LANG=$1 >&3
  exit 102
}

FZF_COMMANDS="Benchmark zsh startup time\t$dotfiles_dir/scripts/misc/benchmark_zsh_startup_time
Benchmark vim startup time\t$dotfiles_dir/scripts/misc/benchmark_vim_startup_time
Decompile dex files to java sources\trun_with_arguments $dotfiles_dir/scripts/misc/decompile_dex
Mac OSX mount NTFS read-write\t$dotfiles_dir/bin/diskutil ntfs_rw -q
Switch to en-US locale\tswitch_locale en_US.UTF-8
Configure JAVA_HOME environment variable\tsource $dotfiles_dir/scripts/misc/configure_java_home_env
"

if [ "$#" -gt 0 ]; then
  usage
fi

source "$dotfiles_dir/scripts/lib/utils/common.sh"
source "$dotfiles_dir/scripts/lib/fzf.sh"
source "$dotfiles_dir/scripts/lib/cmd_fzf.sh"

cmd_fzf_expect result "ctrl-g,ctrl-i,ctrl-d,ctrl-s" \
  --prompt "(CTRL-G:gen CTRl-I:install CTRL-D:edit-dotfiles CTRL-S:search-dotfiles)> "

query="${result[0]}"
key="${result[1]}"
case "$key" in
  ctrl-i)
    cd "$dotfiles_dir/scripts/install"
    file=$(find . -type f | sed 's:^\./::' | fzf --query "$query")
    if [ -n "$file" ]; then
      "./$file"
    fi
    ;;
  ctrl-g)
    "$dotfiles_dir/bin/gen" -q "$query"
    ;;
  ctrl-d)
    exec fe "$dotfiles_dir"
    ;;
  ctrl-s)
    exec s "$dotfiles_dir"
    ;;
esac
