#!/usr/bin/env bash

set -eo pipefail

usage() {
  cat <<-EOF 1>&2
Wrapper for curl utility.

Subcommands:
  time - show time stats
  cors - check if CORS is allowed
EOF
  exit 1
}

source ~/.dotfiles/scripts/lib/path.sh
PATH=$(new_path_exclude ~/.dotfiles/bin)

usage_time() {
  cat <<-EOF 1>&2
Usage: curl time <url>

Show time stats.

Example:
  $> curl time example.com
EOF
  exit 1
}

cmd_time() {
  [ -z "$1" ] && usage_time

  curl -w "\
    \n-------------------------\n\
       namelookup:  %{time_namelookup}s\n\
          connect:  %{time_connect}s\n\
       appconnect:  %{time_appconnect}s\n\
      pretransfer:  %{time_pretransfer}s\n\
         redirect:  %{time_redirect}s\n\
    starttransfer:  %{time_starttransfer}s\n\
    -------------------------\n\
            total:  %{time_total}s\n" "$@"
}

usage_cors() {
  cat <<-EOF 1>&2
Usage: curl cors <test-url> <origin>

Test if the remote resource specified by <test-url> allows the browser to
visit from the <origin>.

CORS is checked by using OPTIONS method. When it is allowed, the HTTP
header 'Access-Control-Allow-Origin' and 'Access-Control-Allow-Methods'
will be present.

The <test-url> may be a non-existent remote resource, and it still returns
'200 OK' when CORS is allowed.

Example:
  $> curl cors http://example.com http://foo.example.com
EOF
  exit 1
}

cmd_cors() {
  local url="$1"
  local origin="$2"
  if [ -z "$url" -o -z "$origin" ]; then
    usage_cors
  fi

  source ~/.dotfiles/scripts/lib/utils/common.sh
  source ~/.dotfiles/scripts/lib/io.sh
  source ~/.dotfiles/scripts/lib/utils/trim.sh

  local output
  io_run_capture_and_display output curl "$url" -H "Origin: $origin" -XOPTIONS -I -s

  echo -e "----\n"

  local allowed_origin=$(str_trim "$(echo "$output" | grep -i Access-Control-Allow-Origin | sed 's/^access-control-allow-origin:[[:space:]]*//i')")
  if [ "$allowed_origin" = "$origin"  ]; then
    echo -n 'CORS is allowed with such methods: '
    str_trim "$(echo "$output" | grep -i Access-Control-Allow-Methods | sed 's/^access-control-allow-methods:[[:space:]]*//i')"
  else
    echo 'CORS is NOT allowed.'
  fi
}

cmd="$1"
case "$1" in
  time | cors)
    shift
    case "$1" in
      -h)
        type "usage_$cmd" &>/dev/null && "usage_$cmd"
        ;;
    esac
    "cmd_$cmd" "$@"
    ;;
  -h)
    usage
    ;;
  -)
    shift
    ;&
    # Fall through
  *)
    curl "$@"
    ;;
esac
