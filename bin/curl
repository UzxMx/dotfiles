#!/usr/bin/env bash

set -eo pipefail

usage() {
  cat <<-EOF 1>&2
Wrapper for curl utility. Pass in '-' to call the original.

Provided subcommands include:

  * time: <url>
      Show time stats

      $> curl time example.com

  * cors: <test-url> <origin>
      Test if the remote resource specified by <test-url> allows the browser to
      visit from the <origin>.

      CORS is checked by using OPTIONS method. When it is allowed, the HTTP
      header 'Access-Control-Allow-Origin' and 'Access-Control-Allow-Methods'
      will be present.

      The <test-url> may be a non-existent remote resource, and it still returns
      '200 OK' when CORS is allowed.

      $> curl cors http://example.com http://foo.example.com

Global options:

  [-h] Show help
EOF
  exit 1
}

source ~/.dotfiles/scripts/lib/path.sh
PATH=$(new_path_exclude ~/.dotfiles/bin)

cmd_time() {
  curl -w "\
    \n-------------------------\n\
       namelookup:  %{time_namelookup}s\n\
          connect:  %{time_connect}s\n\
       appconnect:  %{time_appconnect}s\n\
      pretransfer:  %{time_pretransfer}s\n\
         redirect:  %{time_redirect}s\n\
    starttransfer:  %{time_starttransfer}s\n\
    -------------------------\n\
            total:  %{time_total}s\n" "$@"
}

cmd_cors() {
  url="$1"
  origin="$2"
  if [ -z "$url" ]; then
    echo 'A test url must be specified'
    exit 1
  fi
  if [ -z "$origin" ]; then
    echo 'An origin url must be specified'
    exit 1
  fi

  source ~/.dotfiles/scripts/lib/utils/common.sh
  source ~/.dotfiles/scripts/lib/io.sh
  source ~/.dotfiles/scripts/lib/utils/trim.sh

  local output
  io_run_capture_and_display output curl "$url" -H "Origin: $origin" -XOPTIONS -I -s

  echo -e "----\n"

  local allowed_origin=$(str_trim "$(echo "$output" | grep Access-Control-Allow-Origin | awk -F: '{print $2}')")
  if [ "$allowed_origin" = "$origin"  ]; then
    echo -n 'CORS is allowed with such methods: '
    str_trim "$(echo "$output" | grep Access-Control-Allow-Methods | awk -F: '{print $2}')"
  else
    echo 'CORS is NOT allowed.'
  fi
}

cmd="$1"
case "$1" in
  time | cors)
    shift
    "cmd_$cmd" "$@"
    ;;
  -h)
    usage
    ;;
  -)
    shift
    ;&
    # Fall through
  *)
    curl "$@"
    ;;
esac
