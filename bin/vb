#!/usr/bin/env bash

set -eo pipefail

dotfiles_dir="$(realpath "$(dirname "$BASH_SOURCE")/..")"
vb_dir="$dotfiles_dir/scripts/vb"

usage() {
  cat <<-EOF
Utility for managing VirtualBox vms.

Subcommands:
  s, status      - show status of a vm
  start          - start a vm
  show           - show a vm
  ssh            - ssh into a vm
  stop           - power off one or more vms
  set_cpus       - set the number of cpu
  set_mem        - change memory of a vm (unit is gigabyte)
  enable_bridge  - enable bridged network for a vm, which operates on the 2nd nic
  disable_bridge - disable bridged network for a vm, which operates on the 2nd nic
  list           - list vms, usbhost, etc.
EOF
  exit 1
}

check_vboxmanage() {
  if type -p VBoxManage &>/dev/null; then
    VBOXMANAGE=VBoxManage
  elif type -p VBoxManage.exe &>/dev/null; then
    VBOXMANAGE=VBoxManage.exe
  else
    echo 'Cannot find `VBoxManage` in PATH.'
    exit 1
  fi
}

run() {
  local cmd="$1"
  shift
  case "$1" in
    -h)
      type "usage_$cmd" &>/dev/null && "usage_$cmd"
      ;;
  esac
  "cmd_$cmd" "$@"
}

case "$1" in
  status | start | show | ssh | stop | set_cpus | set_mem | enable_bridge | disable_bridge)
    case "$1" in
      s)
        name="status"
        ;;
      *)
        name="$1"
        ;;
    esac
    source "$vb_dir/$name.sh"
    run "$@"
    ;;
  -h)
    usage
    ;;
  -)
    shift
    check_vboxmanage
    "$VBOXMANAGE" "$@"
    ;;
  *)
    check_vboxmanage
    "$VBOXMANAGE" "$@"
    ;;
esac
