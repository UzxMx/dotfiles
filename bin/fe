#!/usr/bin/env bash
#
# Open the selected file with the default editor. You can also press ctrl-v to
# create a new file from selected file and edit it.

set -eo pipefail

dir="${1:-.}"
if [ -n "$dir" -a ! -d "$dir" ]; then
  echo "Directory $dir does not exist."
  exit 1
fi
shift || true

source ~/.dotfiles/scripts/lib/fzf.sh

call_fzf files --query="$1" --multi --select-1 --exit-0 \
  --prompt '(CTRL-V:copy CTRL-Y:yank)> ' \
  --expect="ctrl-v" \
  < <(fd --type f . "$dir")

if [ "${files[0]}" = "ctrl-v" ]; then
  src_file="${files[1]}"
  if [ -z "$src_file" ]; then
    echo 'A source file is required when creating a new file.'
    exit 1
  fi
  while true; do
    target_file=$(rlwrap -S "Target file: " -P "$src_file" -o cat)
    if [ -e "$target_file" ]; then
      echo "File '$target_file' already exists"
    else
      break
    fi
  done
  cp "$src_file" "$target_file"
  files=("$target_file")
fi

if [ -n "$files" ]; then
  editor=${EDITOR:-vim}
  if [ "$editor" = "vi" -o "$editor" = "vim" -o "$editor" = "nvim" ]; then
    # Invoke `Rooter` command to change to correct root directory.
    args="+Rooter"
  fi
  $editor $args ${files[@]}
fi
