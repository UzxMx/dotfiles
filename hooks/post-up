#!/usr/bin/env zsh
#
# This script will be evaluated after `rcup` finishes.

warn() {
  echo $@
}

abort() {
  echo $@ >>/dev/stderr
  exit 1
}

case $OSTYPE in
  darwin*)
    platform=osx
    [[ ! -e ~/.bin/vscode ]] && ln -s "/Applications/Visual Studio Code.app/Contents/MacOS/Electron" ~/.bin/vscode
    ;;
esac

if [ -n "$platform" -a -f ~/.zshrc.$platform ]; then
  if [ -f ~/.zshrc.platform ]; then
    if [ $? != 0 -o "$(readlink ~/.zshrc.platform)" != "$(ls -d ~)/.zshrc.$platform" ]; then
      warn "Failed to link ~/.zshrc.platform to ~/.zshrc.$platform, please check ~/.zshrc.platform"
    fi
  else
    ln -s ~/.zshrc.$platform ~/.zshrc.platform
  fi
fi

if type load_rbenv &>/dev/null; then
  load_rbenv
fi
erb -T - $(dirname $0)/../vim/vimrc.generated.erb >~/.vim/vimrc.generated
erb -T - $(dirname $0)/../config/nvim/coc-settings.json.erb >~/.config/nvim/coc-settings.json

echo -n 'Checking netcat...'
if type -p nc &>/dev/null; then
  echo 'Found'
elif type -p netcat &>/dev/null; then
  echo 'Found'
else
  abort 'Please ensure netcat installed'
fi

echo -n 'Checking socat...'
if type -p socat &>/dev/null; then
  echo 'Found'
else
  echo 'Not found, installing...'
  if `$(dirname $0)/../scripts/install_socat.sh >/dev/null`; then
    echo 'Done'
  else
    exit 1
  fi
fi

echo -n 'Checking antibody...'
if type antibody &>/dev/null; then
  echo 'Found'
else
  echo 'Not found, installing...'
  curl -sfL git.io/antibody | sudo sh -s - -b /usr/local/bin
  antibody bundle <~/.dotfiles/zsh/plugins.txt >~/.zsh_plugins.sh
fi

echo -n 'Checking js-beautify for vim-autoformat json...'
if type js-beautify &>/dev/null; then
  echo 'Found'
else
  echo 'Not found, installing...'
  npm install -g js-beautify
  echo 'Done'
fi

echo -n 'Checking fzf...'
if type fzf &>/dev/null; then
  echo 'Found'
else
  echo 'Not found, installing...'
  if `$(dirname $0)/../scripts/install_fzf.sh >/dev/null`; then
    echo 'Done'
  else
    exit 1
  fi
fi

echo -n 'Checking fd...'
if type fd &>/dev/null; then
  echo 'Found'
else
  echo 'Not found, installing...'
  if `$(dirname $0)/../scripts/install_fd.sh >/dev/null`; then
    echo 'Done'
  else
    exit 1
  fi
fi

echo -n 'Checking hstr...'
if type hstr &>/dev/null; then
  echo 'Found'
else
  echo 'Not found, installing...'
  if `$(dirname $0)/../scripts/install_hstr.sh >/dev/null`; then
    echo 'Done'
  else
    exit 1
  fi
fi

echo -n 'Checking rlwrap...'
if type -p rlwrap &>/dev/null; then
  echo 'Found'
else
  echo 'Not found, installing...'
  if `$(dirname $0)/../scripts/install_rlwrap.sh >/dev/null`; then
    echo 'Done'
  else
    exit 1
  fi
fi
