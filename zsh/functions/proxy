# vi: ft=zsh

# HTTP proxy
dump_http_proxy() {
  echo "http_proxy: $http_proxy"
  echo "HTTP_PROXY: $HTTP_PROXY"
  echo "https_proxy: $https_proxy"
  echo "HTTPS_PROXY: $HTTPS_PROXY"
}

enable_http_proxy() {
  local list host port
  host=${DEFAULT_HTTP_PROXY_HOST:-localhost}
  host=${1:-$host}
  list=($(echo $host | tr ":" "\n"))
  host=${list[1]}
  port=${list[2]:-8123}
  export http_proxy=http://$host:$port
  export HTTP_PROXY=http://$host:$port
  export https_proxy=http://$host:$port
  export HTTPS_PROXY=http://$host:$port
  dump_http_proxy
}

disable_http_proxy() {
  unset http_proxy
  unset HTTP_PROXY
  unset https_proxy
  unset HTTPS_PROXY
  dump_http_proxy
}

# Docker HTTP proxy
# See https://docs.docker.com/config/daemon/systemd/#httphttps-proxy
dump_docker_proxy() {
  systemctl show --property=Environment docker
}

enable_docker_proxy() {
  local list host port
  host=${DEFAULT_HTTP_PROXY_HOST:-localhost}
  host=${1:-$host}
  list=($(echo $host | tr ":" "\n"))
  host=${list[1]}
  port=${list[2]:-8123}

  sudo tee /etc/systemd/system/docker.service.d/http-proxy.conf >/dev/null <<-EOF
[Service]
Environment="HTTP_PROXY=http://$host:$port/"
EOF
  sudo tee /etc/systemd/system/docker.service.d/https-proxy.conf >/dev/null <<-EOF
[Service]
Environment="HTTPS_PROXY=http://$host:$port/"
EOF

  sudo systemctl daemon-reload
  sudo systemctl restart docker
}

disable_docker_proxy() {
  sudo rm /etc/systemd/system/docker.service.d/{http,https}-proxy.conf
  sudo systemctl daemon-reload
  sudo systemctl restart docker
}

# Git proxy
dump_git_proxy() {
  echo "Git http/https proxy:"
  echo "http.proxy=$(git config --get http.proxy)"
  echo "https.proxy=$(git config --get https.proxy)"

  echo
  echo "Git ssh proxy:"
  dump_http_proxy
}

enable_git_proxy() {
  local list host port
  host=${DEFAULT_HTTP_PROXY_HOST:-localhost}
  host=${1:-$host}
  list=($(echo $host | tr ":" "\n"))
  host=${list[1]}
  port=${list[2]:-8123}

  git config --global http.proxy http://$host:$port
  git config --global https.proxy https://$host:$port

  # When http/https proxy environment variable exists, ssh-proxy will automatically use that
  # proxy. See ~/.ssh/config for more info.
  enable_http_proxy $host:$port >/dev/null

  dump_git_proxy
}

disable_git_proxy() {
  git config --unset --global http.proxy
  git config --unset --global https.proxy

  disable_http_proxy >/dev/null

  dump_git_proxy
}
